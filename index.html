<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat + Voice</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: {
                            50: '#f0f4f9',
                            100: '#e1e7ee',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'wave': 'wave 1.5s linear infinite'
                    },
                    keyframes: {
                        wave: {
                            '0%, 100%': { transform: 'scaleY(1)' },
                            '50%': { transform: 'scaleY(0.6)' },
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .prose pre { background-color: #1e1e1e !important; border-radius: 0.5rem; margin: 0.5rem 0; }
        .prose code { color: #eb5757; background: rgba(0,0,0,0.05); padding: 2px 4px; border-radius: 4px; font-size: 0.9em; }
        .dark .prose code { color: #f87171; background: rgba(255,255,255,0.1); }
        
        #loading { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .dark #loading { background: #0f172a; color: white; }
        
        /* Voice Animation Bars */
        .voice-bar { width: 4px; background-color: #ef4444; border-radius: 99px; animation: wave 1s ease-in-out infinite; }
        .voice-bar:nth-child(2) { animation-delay: 0.1s; height: 24px; }
        .voice-bar:nth-child(3) { animation-delay: 0.2s; height: 16px; }
        .voice-bar:nth-child(1), .voice-bar:nth-child(4) { height: 12px; }
        
        body { height: 100dvh; overflow: hidden; }
    </style>
</head>
<body class="bg-gemini-50 text-slate-800 dark:bg-gemini-900 dark:text-slate-100 transition-colors duration-200">

    <div id="loading">
        <div class="flex flex-col items-center gap-4">
            <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p>Initializing...</p>
        </div>
    </div>

    <div id="app" class="hidden flex h-full w-full relative">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden glass backdrop-blur-sm" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-[280px] bg-gemini-100 dark:bg-slate-900 transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 flex flex-col border-r border-slate-200 dark:border-slate-800">
            <div class="p-4">
                <button onclick="createNewChat()" class="w-full flex items-center gap-3 bg-slate-200 dark:bg-slate-800 hover:bg-slate-300 dark:hover:bg-slate-700 px-4 py-3 rounded-full transition-colors font-medium text-sm">
                    <i class="fa-solid fa-plus text-blue-500"></i>
                    <span>New Chat</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-list"></div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-800 flex items-center justify-between">
                <button onclick="toggleSettings()" class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 hover:text-blue-500">
                    <i class="fa-solid fa-gear"></i> Settings
                </button>
                <button onclick="toggleTheme()" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-200 dark:hover:bg-slate-800">
                    <i id="theme-icon" class="fa-solid fa-moon"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative w-full bg-white dark:bg-gemini-900">
            <header class="h-14 flex items-center justify-between px-4 border-b border-slate-100 dark:border-slate-800 shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2 text-slate-500 hover:text-slate-800 dark:hover:text-white">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <span id="current-model-display" class="text-xs font-mono bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300 px-2 py-1 rounded">Model</span>
                </div>
                <button id="stop-speak-btn" onclick="stopSpeaking()" class="hidden flex items-center gap-2 bg-red-100 dark:bg-red-900/40 text-red-600 dark:text-red-300 px-3 py-1 rounded-full text-xs font-semibold animate-pulse">
                    <i class="fa-solid fa-stop"></i> Stop Speaking
                </button>
                <button id="chat-options-btn" onclick="toggleChatOptions()" class="hidden p-2 text-slate-400 hover:text-red-500">
                    <i class="fa-solid fa-ellipsis-vertical"></i>
                </button>
            </header>

            <div id="chat-options-menu" class="hidden absolute top-12 right-4 bg-white dark:bg-slate-800 shadow-xl rounded-lg border border-slate-200 dark:border-slate-700 z-20 w-40 overflow-hidden">
                <button onclick="startRenameChat()" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700 flex items-center gap-2"><i class="fa-solid fa-pen"></i> Rename</button>
                <button onclick="deleteCurrentChat()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 flex items-center gap-2"><i class="fa-solid fa-trash"></i> Delete</button>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center opacity-50">
                    <i class="fa-solid fa-microphone-lines text-4xl mb-4 text-blue-500"></i>
                    <h2 class="text-2xl font-semibold mb-2">Voice & Text AI</h2>
                    <p class="text-sm max-w-md">Type or tap the microphone to speak.</p>
                </div>
            </div>

            <div class="shrink-0 p-4 bg-white dark:bg-gemini-900 w-full max-w-4xl mx-auto">
                <div id="listening-indicator" class="hidden absolute bottom-20 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-2 rounded-full shadow-lg flex items-center gap-3 z-50">
                    <div class="flex items-center gap-1 h-6">
                        <div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div><div class="voice-bar"></div>
                    </div>
                    <span class="text-sm font-semibold">Listening...</span>
                </div>

                <div class="relative flex items-end gap-2 bg-gemini-50 dark:bg-slate-800 rounded-3xl p-2 border border-transparent focus-within:border-blue-300 dark:focus-within:border-blue-700 transition-all shadow-sm">
                    <textarea 
                        id="user-input" 
                        rows="1" 
                        placeholder="Message..." 
                        class="w-full bg-transparent border-0 focus:ring-0 resize-none max-h-32 py-3 px-4 text-slate-800 dark:text-slate-100 placeholder-slate-400"
                        oninput="autoResize(this)"
                        onkeydown="handleEnter(event)"
                    ></textarea>
                    
                    <button id="mic-btn" onclick="toggleMic()" class="p-3 text-slate-500 hover:text-red-500 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-full transition-colors mb-1">
                        <i class="fa-solid fa-microphone"></i>
                    </button>

                    <button id="send-btn" onclick="sendMessage()" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-full flex-shrink-0 transition-transform active:scale-95 mb-1 mr-1 disabled:opacity-50">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
                <div class="text-center mt-2">
                    <p class="text-[10px] text-slate-400">AI can make mistakes.</p>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleSettings()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 border border-slate-200 dark:border-slate-800">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">OpenRouter API Key</label>
                    <input type="password" id="api-key-input" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">Model ID</label>
                    <input type="text" id="model-input" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-500 mb-1">System Prompt</label>
                    <textarea id="system-prompt-input" rows="3" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium">Auto-read Voice Responses</span>
                    <input type="checkbox" id="auto-read-check" checked class="w-4 h-4">
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="saveSettings()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">Save & Close</button>
            </div>
        </div>
    </div>

    <div id="rename-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeRenameModal()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6">
            <h3 class="text-lg font-bold mb-4">Rename Chat</h3>
            <input type="text" id="rename-input" class="w-full bg-slate-100 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-3 py-2 text-sm mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="closeRenameModal()" class="px-4 py-2 text-sm text-slate-500">Cancel</button>
                <button onclick="confirmRename()" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        const STATE = {
            chats: [],
            currentChatId: null,
            settings: {
                apiKey: '',
                model: 'deepseek/deepseek-r1:free',
                systemPrompt: 'You are a helpful AI assistant.',
                theme: 'light',
                autoRead: true
            },
            isGenerating: false,
            recognition: null,
            wasVoiceInput: false // Tracks if current query was spoken
        };

        let els = {};

        // --- Safe Storage ---
        const SafeStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } },
            setItem: (key, val) => { try { localStorage.setItem(key, val); } catch (e) {} }
        };

        // --- Init ---
        window.addEventListener('load', () => {
            try {
                initDOM();
                loadState();
                applyTheme();
                initVoice(); // New Voice Init
                
                if (STATE.chats.length === 0) createNewChat(false);
                else {
                    if (!STATE.currentChatId) STATE.currentChatId = STATE.chats[0].id;
                    renderSidebar();
                    renderChat();
                }

                if (typeof marked !== 'undefined') {
                    marked.setOptions({
                        highlight: (code, lang) => {
                            if (typeof highlight !== 'undefined') {
                                return highlight.highlight(code, { language: highlight.getLanguage(lang) ? lang : 'plaintext' }).value;
                            }
                            return code;
                        },
                        breaks: true
                    });
                }
            } catch (error) {
                console.error("Init failed", error);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('app').classList.remove('hidden');
            }
        });

        function initDOM() {
            els = {
                app: document.getElementById('app'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                chatContainer: document.getElementById('chat-container'),
                chatList: document.getElementById('chat-list'),
                userInput: document.getElementById('user-input'),
                welcomeScreen: document.getElementById('welcome-screen'),
                settingsModal: document.getElementById('settings-modal'),
                renameModal: document.getElementById('rename-modal'),
                chatOptionsMenu: document.getElementById('chat-options-menu'),
                chatOptionsBtn: document.getElementById('chat-options-btn'),
                apiKeyInput: document.getElementById('api-key-input'),
                modelInput: document.getElementById('model-input'),
                systemPromptInput: document.getElementById('system-prompt-input'),
                autoReadCheck: document.getElementById('auto-read-check'),
                renameInput: document.getElementById('rename-input'),
                currentModelDisplay: document.getElementById('current-model-display'),
                sendBtn: document.getElementById('send-btn'),
                micBtn: document.getElementById('mic-btn'),
                listeningIndicator: document.getElementById('listening-indicator'),
                stopSpeakBtn: document.getElementById('stop-speak-btn')
            };
        }

        // --- Voice Recognition Logic ---
        function initVoice() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                STATE.recognition = new SpeechRecognition();
                STATE.recognition.continuous = false;
                STATE.recognition.interimResults = false;
                STATE.recognition.lang = 'en-US';

                STATE.recognition.onstart = () => {
                    els.listeningIndicator.classList.remove('hidden');
                    els.micBtn.classList.add('text-red-500', 'animate-pulse');
                };

                STATE.recognition.onend = () => {
                    els.listeningIndicator.classList.add('hidden');
                    els.micBtn.classList.remove('text-red-500', 'animate-pulse');
                };

                STATE.recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    els.userInput.value = transcript;
                    autoResize(els.userInput);
                    STATE.wasVoiceInput = true; // Mark as voice input
                };

                STATE.recognition.onerror = (event) => {
                    console.error("Voice Error", event.error);
                    els.listeningIndicator.classList.add('hidden');
                    alert("Voice input error: " + event.error);
                };
            } else {
                els.micBtn.style.display = 'none'; // Hide if not supported
            }
        }

        function toggleMic() {
            if (!STATE.recognition) return alert("Browser does not support voice.");
            try {
                STATE.recognition.start();
            } catch (e) {
                STATE.recognition.stop();
            }
        }

        // --- Voice Synthesis (TTS) Logic ---
        function cleanTextForSpeech(text) {
            // Remove code blocks, markdown symbols for smoother reading
            return text
                .replace(/```[\s\S]*?```/g, "Code block omitted.") // Remove code blocks
                .replace(/`([^`]+)`/g, "$1") // Inline code
                .replace(/(\*\*|__)(.*?)\1/g, "$2") // Bold
                .replace(/(\*|_)(.*?)\1/g, "$2") // Italic
                .replace(/\[([^\]]+)\]\([^\)]+\)/g, "$1") // Links
                .replace(/[#\-]/g, "") // Headers/Lists
                .trim();
        }

        function speakText(text) {
            window.speechSynthesis.cancel(); // Stop previous
            const cleanText = cleanTextForSpeech(text);
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            utterance.onstart = () => els.stopSpeakBtn.classList.remove('hidden');
            utterance.onend = () => els.stopSpeakBtn.classList.add('hidden');
            utterance.onerror = () => els.stopSpeakBtn.classList.add('hidden');

            window.speechSynthesis.speak(utterance);
        }

        function stopSpeaking() {
            window.speechSynthesis.cancel();
            els.stopSpeakBtn.classList.add('hidden');
        }

        // --- Core Functions ---
        function saveState() {
            SafeStorage.setItem('gemini_clone_state', JSON.stringify(STATE));
        }

        function loadState() {
            const saved = SafeStorage.getItem('gemini_clone_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    STATE.chats = parsed.chats || [];
                    STATE.currentChatId = parsed.currentChatId;
                    STATE.settings = { ...STATE.settings, ...parsed.settings };
                } catch (e) {}
            }
            els.apiKeyInput.value = STATE.settings.apiKey || '';
            els.modelInput.value = STATE.settings.model;
            els.systemPromptInput.value = STATE.settings.systemPrompt;
            els.autoReadCheck.checked = STATE.settings.autoRead !== false;
            els.currentModelDisplay.innerText = STATE.settings.model.split('/')[1] || STATE.settings.model;
        }

        function renderChat() {
            const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
            els.chatContainer.innerHTML = '';
            
            if (!chat || chat.messages.length === 0) {
                els.welcomeScreen.classList.remove('hidden');
                els.chatOptionsBtn.classList.add('hidden');
                return;
            }

            els.welcomeScreen.classList.add('hidden');
            els.chatOptionsBtn.classList.remove('hidden');

            chat.messages.forEach(msg => appendMessageToDOM(msg.role, msg.content));
            scrollToBottom();
        }

        function appendMessageToDOM(role, content) {
            const div = document.createElement('div');
            const isUser = role === 'user';
            div.className = `w-full flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubbleWrapper = document.createElement('div');
            bubbleWrapper.className = `max-w-[85%] md:max-w-[75%] flex flex-col ${isUser ? 'items-end' : 'items-start'}`;

            const bubble = document.createElement('div');
            bubble.className = `rounded-2xl px-5 py-3 shadow-sm text-sm md:text-base leading-relaxed overflow-hidden ${
                isUser 
                ? 'bg-blue-600 text-white rounded-tr-sm' 
                : 'bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-tl-sm text-slate-800 dark:text-slate-100 prose dark:prose-invert max-w-none'
            }`;

            if (isUser) {
                bubble.innerText = content;
            } else {
                bubble.innerHTML = (typeof marked !== 'undefined') ? marked.parse(content) : content;
            }
            bubbleWrapper.appendChild(bubble);

            // Add Speaker Icon for AI messages
            if (!isUser) {
                const actions = document.createElement('div');
                actions.className = "flex items-center gap-2 mt-1 ml-1";
                
                const speakBtn = document.createElement('button');
                speakBtn.className = "text-slate-400 hover:text-blue-500 text-xs p-1";
                speakBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                speakBtn.onclick = () => speakText(content);
                
                actions.appendChild(speakBtn);
                bubbleWrapper.appendChild(actions);
            }

            div.appendChild(bubbleWrapper);
            els.chatContainer.appendChild(div);
        }

        // --- Messaging ---
        async function sendMessage() {
            if (STATE.isGenerating) return;
            const text = els.userInput.value.trim();
            if (!text) return;
            if (!STATE.settings.apiKey) { alert('API Key required'); toggleSettings(); return; }

            // Check if voice was used for this input (before clearing)
            const shouldAutoRead = STATE.wasVoiceInput && STATE.settings.autoRead;
            STATE.wasVoiceInput = false; // Reset flag

            els.userInput.value = '';
            els.userInput.style.height = 'auto';
            STATE.isGenerating = true;
            els.sendBtn.disabled = true;
            els.welcomeScreen.classList.add('hidden');

            const chatIndex = STATE.chats.findIndex(c => c.id === STATE.currentChatId);
            STATE.chats[chatIndex].messages.push({ role: 'user', content: text });
            appendMessageToDOM('user', text);
            
            if (STATE.chats[chatIndex].messages.length === 1) {
                STATE.chats[chatIndex].title = text.slice(0, 30);
                renderSidebar();
            }

            // AI Placeholder
            STATE.chats[chatIndex].messages.push({ role: 'assistant', content: '' });
            
            // Create DOM elements manually for streaming
            const wrapperDiv = document.createElement('div');
            wrapperDiv.className = 'w-full flex justify-start';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'max-w-[85%] md:max-w-[75%] flex flex-col items-start';
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'rounded-2xl px-5 py-3 shadow-sm text-sm md:text-base leading-relaxed bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-tl-sm text-slate-800 dark:text-slate-100 prose dark:prose-invert';
            bubbleDiv.innerHTML = '<span class="animate-pulse">‚óè</span>';
            
            contentDiv.appendChild(bubbleDiv);
            wrapperDiv.appendChild(contentDiv);
            els.chatContainer.appendChild(wrapperDiv);
            scrollToBottom();

            try {
                const messagesPayload = [
                    { role: 'system', content: STATE.settings.systemPrompt },
                    ...STATE.chats[chatIndex].messages.slice(0, -1)
                ];

                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${STATE.settings.apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": window.location.href, 
                        "X-Title": "Universal AI Chat"
                    },
                    body: JSON.stringify({
                        model: STATE.settings.model,
                        messages: messagesPayload,
                        stream: true
                    })
                });

                if (!response.ok) throw new Error("API Error");
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                let fullContent = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    chunk.split('\n').forEach(line => {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.replace('data: ', '').trim();
                            if (dataStr === '[DONE]') return;
                            try {
                                const token = JSON.parse(dataStr).choices[0]?.delta?.content || "";
                                fullContent += token;
                                bubbleDiv.innerHTML = (typeof marked !== 'undefined') ? marked.parse(fullContent) : fullContent;
                                scrollToBottom();
                            } catch (e) {}
                        }
                    });
                }

                // Finish
                STATE.chats[chatIndex].messages.pop(); // Remove placeholder
                STATE.chats[chatIndex].messages.push({ role: 'assistant', content: fullContent });
                saveState();
                
                // Add speaker button after stream finishes
                const actions = document.createElement('div');
                actions.className = "flex items-center gap-2 mt-1 ml-1";
                const speakBtn = document.createElement('button');
                speakBtn.className = "text-slate-400 hover:text-blue-500 text-xs p-1";
                speakBtn.innerHTML = '<i class="fa-solid fa-volume-high"></i>';
                speakBtn.onclick = () => speakText(fullContent);
                actions.appendChild(speakBtn);
                contentDiv.appendChild(actions);

                if (typeof highlight !== 'undefined') document.querySelectorAll('pre code').forEach(b => highlight.highlightElement(b));

                // AUTO-READ if enabled and voice was used
                if (shouldAutoRead) speakText(fullContent);

            } catch (error) {
                bubbleDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            } finally {
                STATE.isGenerating = false;
                els.sendBtn.disabled = false;
            }
        }

        // --- Helpers ---
        function autoResize(t) { t.style.height = 'auto'; t.style.height = t.scrollHeight + 'px'; }
        function handleEnter(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        function scrollToBottom() { els.chatContainer.scrollTop = els.chatContainer.scrollHeight; }
        
        // --- Settings & UI Toggles ---
        function toggleSettings() { els.settingsModal.classList.toggle('hidden'); }
        function saveSettings() {
            STATE.settings.apiKey = els.apiKeyInput.value.trim();
            STATE.settings.model = els.modelInput.value.trim() || 'deepseek/deepseek-r1:free';
            STATE.settings.systemPrompt = els.systemPromptInput.value.trim();
            STATE.settings.autoRead = els.autoReadCheck.checked;
            els.currentModelDisplay.innerText = STATE.settings.model.split('/')[1] || STATE.settings.model;
            saveState();
            toggleSettings();
        }
        function toggleSidebar() {
            els.sidebar.classList.toggle('-translate-x-full');
            els.sidebarOverlay.classList.toggle('hidden');
        }
        function createNewChat(render=true) {
            const newChat = { id: Date.now().toString(), title: 'New Chat', messages: [], model: STATE.settings.model };
            STATE.chats.unshift(newChat);
            STATE.currentChatId = newChat.id;
            saveState();
            if(render) { renderSidebar(); renderChat(); if(window.innerWidth < 1024) toggleSidebar(); }
        }
        function switchChat(id) { STATE.currentChatId = id; saveState(); renderSidebar(); renderChat(); if(window.innerWidth < 1024) toggleSidebar(); }
        function toggleTheme() { STATE.settings.theme = STATE.settings.theme==='light'?'dark':'light'; applyTheme(); saveState(); }
        function applyTheme() {
            document.documentElement.classList.toggle('dark', STATE.settings.theme === 'dark');
            document.getElementById('theme-icon').className = STATE.settings.theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
        }
        function toggleChatOptions() { els.chatOptionsMenu.classList.toggle('hidden'); }
        function deleteCurrentChat() {
            if(!confirm('Delete chat?')) return;
            STATE.chats = STATE.chats.filter(c => c.id !== STATE.currentChatId);
            STATE.currentChatId = STATE.chats[0]?.id || null;
            if(!STATE.currentChatId) createNewChat(false);
            saveState(); renderSidebar(); renderChat(); toggleChatOptions();
        }
        function startRenameChat() { els.renameInput.value = STATE.chats.find(c => c.id === STATE.currentChatId).title; els.renameModal.classList.remove('hidden'); toggleChatOptions(); }
        function closeRenameModal() { els.renameModal.classList.add('hidden'); }
        function confirmRename() {
            const t = els.renameInput.value.trim();
            if(t) { STATE.chats.find(c => c.id === STATE.currentChatId).title = t; saveState(); renderSidebar(); }
            closeRenameModal();
        }
    </script>
</body>
</html>
