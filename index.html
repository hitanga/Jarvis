<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI Chat + Voice (Fixed)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gemini: { 50: '#f0f4f9', 100: '#e1e7ee', 800: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { height: 100dvh; overflow: hidden; font-family: ui-sans-serif, system-ui, sans-serif; }
        #loading { position: fixed; inset: 0; background: #fff; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .dark #loading { background: #0f172a; color: white; }
        .prose pre { background-color: #1e1e1e !important; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; }
        .voice-bar { width: 4px; background-color: #ef4444; border-radius: 99px; animation: wave 1s ease-in-out infinite; }
        @keyframes wave { 0%, 100% { transform: scaleY(1); } 50% { transform: scaleY(0.5); } }
    </style>
</head>
<body class="bg-gemini-50 text-slate-800 dark:bg-gemini-900 dark:text-slate-100 transition-colors duration-200">

    <div id="loading">Initialising App...</div>

    <div id="app" class="hidden flex h-full w-full relative">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden" onclick="toggleSidebar()"></div>

        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-[280px] bg-gemini-100 dark:bg-slate-900 transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 flex flex-col border-r border-slate-200 dark:border-slate-800">
            <div class="p-4">
                <button onclick="createNewChat()" class="w-full flex items-center gap-3 bg-white dark:bg-slate-800 hover:shadow-md px-4 py-3 rounded-full transition-all font-medium text-sm">
                    <i class="fa-solid fa-plus text-blue-500"></i>
                    <span>New Chat</span>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto px-2 space-y-1" id="chat-list">
                </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-800 flex flex-col gap-2">
                <button onclick="toggleSettings()" class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 hover:text-blue-500">
                    <i class="fa-solid fa-gear w-5"></i> Settings
                </button>
                <button onclick="toggleTheme()" class="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 hover:text-blue-500">
                    <i id="theme-icon" class="fa-solid fa-moon w-5"></i> Appearance
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative w-full bg-white dark:bg-gemini-900 overflow-hidden">
            <header class="h-14 flex items-center justify-between px-4 border-b border-slate-100 dark:border-slate-800">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="lg:hidden p-2"><i class="fa-solid fa-bars"></i></button>
                    <span id="current-model-display" class="text-xs font-mono bg-blue-100 dark:bg-blue-900 px-2 py-1 rounded">Model</span>
                </div>
                <button id="stop-speak-btn" onclick="stopSpeaking()" class="hidden bg-red-500 text-white px-3 py-1 rounded-full text-xs animate-pulse">Stop Voice</button>
                <button onclick="toggleChatOptions()" id="chat-options-btn" class="p-2"><i class="fa-solid fa-ellipsis-vertical"></i></button>
            </header>

            <div id="chat-options-menu" class="hidden absolute top-12 right-4 bg-white dark:bg-slate-800 shadow-xl rounded-lg border z-50 w-40 overflow-hidden">
                <button onclick="startRenameChat()" class="w-full text-left px-4 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-700">Rename</button>
                <button onclick="deleteCurrentChat()" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-red-50">Delete</button>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6">
                </div>

            <div class="p-4 bg-white dark:bg-gemini-900 max-w-4xl mx-auto w-full">
                <div id="listening-indicator" class="hidden flex justify-center items-center gap-2 mb-2 text-red-500 font-bold text-sm">
                    <div class="voice-bar h-4"></div><span>Listening...</span>
                </div>
                <div class="relative flex items-end gap-2 bg-slate-100 dark:bg-slate-800 rounded-2xl p-2 border border-transparent focus-within:border-blue-400">
                    <textarea id="user-input" rows="1" placeholder="Message Gemini Clone..." class="w-full bg-transparent border-0 focus:ring-0 resize-none py-3 px-4 max-h-40" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
                    <button onclick="toggleMic()" class="p-3 text-slate-500 hover:text-red-500"><i class="fa-solid fa-microphone"></i></button>
                    <button id="send-btn" onclick="sendMessage()" class="p-3 bg-blue-600 text-white rounded-xl"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Settings</h3>
            <div class="space-y-4 text-sm">
                <div><label class="block mb-1 text-slate-500">OpenRouter API Key</label><input type="password" id="api-key-input" class="w-full p-2 rounded border dark:bg-slate-800"></div>
                <div><label class="block mb-1 text-slate-500">Model Name</label><input type="text" id="model-input" class="w-full p-2 rounded border dark:bg-slate-800"></div>
            </div>
            <button onclick="saveSettings()" class="mt-6 w-full bg-blue-600 text-white py-2 rounded-lg">Save Settings</button>
        </div>
    </div>

    <div id="rename-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 bg-black/50">
        <div class="bg-white dark:bg-slate-900 p-6 rounded-2xl w-full max-w-sm">
            <h3 class="font-bold mb-4">Rename Chat</h3>
            <input type="text" id="rename-input" class="w-full p-2 rounded border dark:bg-slate-800 mb-4">
            <div class="flex gap-2"><button onclick="document.getElementById('rename-modal').classList.add('hidden')" class="flex-1">Cancel</button><button onclick="confirmRename()" class="flex-1 bg-blue-600 text-white py-2 rounded">Save</button></div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let STATE = {
            chats: [],
            currentChatId: null,
            settings: { apiKey: '', model: 'deepseek/deepseek-r1:free', theme: 'light' }
        };

        const els = {};
        let recognition = null;

        // --- Load/Save ---
        function load() {
            const saved = localStorage.getItem('gemini_voice_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    STATE = { ...STATE, ...parsed };
                } catch(e) { console.error("Data Corrupt"); }
            }
        }
        function save() { localStorage.setItem('gemini_voice_state', JSON.stringify(STATE)); }

        // --- Sidebar Logic (The Fix) ---
        function renderSidebar() {
            const list = document.getElementById('chat-list');
            if (!list) return;
            list.innerHTML = '';
            
            STATE.chats.forEach(chat => {
                const isActive = chat.id === STATE.currentChatId;
                const btn = document.createElement('div');
                btn.className = `mx-2 p-3 rounded-xl cursor-pointer flex items-center gap-3 transition-all ${isActive ? 'bg-blue-100 dark:bg-blue-900/50 text-blue-600 font-bold' : 'hover:bg-slate-200 dark:hover:bg-slate-800'}`;
                btn.onclick = () => switchChat(chat.id);
                btn.innerHTML = `<i class="fa-regular fa-comment text-xs"></i><span class="truncate text-sm">${chat.title || 'Untitled Chat'}</span>`;
                list.appendChild(btn);
            });
        }

        function createNewChat() {
            const newId = Date.now().toString();
            const newChat = { id: newId, title: 'New Chat', messages: [] };
            STATE.chats.unshift(newChat);
            STATE.currentChatId = newId;
            save();
            renderSidebar();
            renderChat();
            if (window.innerWidth < 1024) toggleSidebar();
        }

        function switchChat(id) {
            STATE.currentChatId = id;
            save();
            renderSidebar();
            renderChat();
            if (window.innerWidth < 1024) toggleSidebar();
        }

        // --- Core UI Functions ---
        function renderChat() {
            const container = document.getElementById('chat-container');
            const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
            container.innerHTML = '';
            if (chat && chat.messages) {
                chat.messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                    div.innerHTML = `<div class="max-w-[85%] p-4 rounded-2xl ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-100 dark:bg-slate-800 prose dark:prose-invert rounded-tl-none'}">${marked.parse(msg.content)}</div>`;
                    container.appendChild(div);
                });
            }
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text || !STATE.settings.apiKey) return;

            const chat = STATE.chats.find(c => c.id === STATE.currentChatId);
            chat.messages.push({ role: 'user', content: text });
            if (chat.title === 'New Chat') chat.title = text.substring(0, 25);
            
            input.value = '';
            renderChat();
            renderSidebar();

            try {
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${STATE.settings.apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: STATE.settings.model, messages: chat.messages })
                });
                const data = await response.json();
                const aiText = data.choices[0].message.content;
                chat.messages.push({ role: 'assistant', content: aiText });
                save();
                renderChat();
            } catch (e) { alert("API Error. Check Key."); }
        }

        // --- Voice Support ---
        function initVoice() {
            const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (Speech) {
                recognition = new Speech();
                recognition.onresult = (e) => {
                    document.getElementById('user-input').value = e.results[0][0].transcript;
                };
                recognition.onstart = () => document.getElementById('listening-indicator').classList.remove('hidden');
                recognition.onend = () => document.getElementById('listening-indicator').classList.add('hidden');
            }
        }
        function toggleMic() { recognition ? recognition.start() : alert("Voice not supported"); }

        // --- Helpers ---
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay').classList.toggle('hidden'); }
        function toggleTheme() { STATE.settings.theme = STATE.settings.theme === 'light' ? 'dark' : 'light'; applyTheme(); save(); }
        function applyTheme() {
            document.documentElement.classList.toggle('dark', STATE.settings.theme === 'dark');
            document.getElementById('theme-icon').className = STATE.settings.theme === 'dark' ? 'fa-solid fa-sun w-5' : 'fa-solid fa-moon w-5';
        }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function saveSettings() {
            STATE.settings.apiKey = document.getElementById('api-key-input').value;
            STATE.settings.model = document.getElementById('model-input').value;
            save(); toggleSettings();
        }

        // --- Init on Start ---
        window.onload = () => {
            load();
            applyTheme();
            initVoice();
            if (STATE.chats.length === 0) createNewChat();
            renderSidebar();
            renderChat();
            
            document.getElementById('api-key-input').value = STATE.settings.apiKey;
            document.getElementById('model-input').value = STATE.settings.model;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('app').classList.remove('hidden');
        };
    </script>
</body>
</html>
