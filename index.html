// --- UPDATED VOICE-TRIGGERED STOP LOGIC ---

function setupSpeechRecognition() {
    const Speech = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!Speech) return;
    
    recognition = new Speech();
    recognition.lang = 'en-US'; 
    recognition.continuous = false;
    recognition.interimResults = true; // Enabled to hear "Stop" quickly

    recognition.onresult = (e) => {
        const transcript = Array.from(e.results)
            .map(result => result[0])
            .map(result => result.transcript)
            .join('').toLowerCase();

        // VOICE INTERRUPT CHECK: If AI is talking and you say "Stop"
        if (STATE.isAITalking && (transcript.includes("stop") || transcript.includes("chup") || transcript.includes("bas"))) {
            stopSpeech();
            return;
        }

        // Standard message processing
        if (e.results[0].isFinal) {
            document.getElementById('user-input').value = transcript;
            sendMessage();
        }
    };

    recognition.onend = () => {
        updateStatus(false);
        // The loop remains untouched
        if (STATE.isRobotOn && !STATE.isAITalking) {
            setTimeout(() => {
                if (STATE.isRobotOn && !STATE.isAITalking) {
                    try { recognition.start(); } catch(e) {}
                }
            }, 300); 
        }
    };
}

function speak(text) {
    synth.cancel();
    STATE.isAITalking = true;
    
    // We keep the mic ACTIVE even while speaking to hear the "Stop" command
    // But we reduce its sensitivity or ignore long sentences
    if (STATE.isRobotOn) {
        try { recognition.start(); } catch(e) {}
    }

    const utterance = new SpeechSynthesisUtterance(text.replace(/[#*`]/g, ''));
    const voices = synth.getVoices();
    const hindiVoice = voices.find(v => v.lang.includes('hi')) || voices.find(v => v.lang.includes('IN'));
    
    if (hindiVoice) {
        utterance.voice = hindiVoice;
        utterance.lang = 'hi-IN';
    }

    utterance.onstart = () => document.getElementById('stop-btn').classList.remove('hidden');
    
    utterance.onend = () => {
        STATE.isAITalking = false;
        document.getElementById('stop-btn').classList.add('hidden');
        // Ensure mic stays/restarts in robot mode
        if (STATE.isRobotOn) {
            setTimeout(() => { if (STATE.isRobotOn) try { recognition.start(); } catch(e) {} }, 500);
        }
    };
    synth.speak(utterance);
}
